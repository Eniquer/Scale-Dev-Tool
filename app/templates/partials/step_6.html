<div id="loadingOverlay"
    class="visually-hidden position-absolute top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex align-items-center justify-content-center"
    style="z-index:1050">
    <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Loadingâ€¦</span>
    </div>
</div>

<div id="step2-content" data-get-sync-function="init"></div>
<div id="area1">
    <div class="container-fluid">
        <h2 class="h3 mb-4">Step 6: Scale Purification and Refinement</h2>

        <div class="card mb-4">
            <div class="card-body">
                <h4 class="card-title mb-3">Data Source</h4>
                <div class="small text-muted mb-2">Choose between simulated Likert responses from Step 5 or upload your own CSV file.</div>
                <div class="d-flex flex-wrap gap-3 mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="dataSource" id="srcSimulated" value="simulated" checked>
                        <label class="form-check-label" for="srcSimulated">Use Simulated Data (Step 5)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="dataSource" id="srcUpload" value="upload">
                        <label class="form-check-label" for="srcUpload">Upload CSV</label>
                    </div>
                </div>
                <div id="uploadBlock" class="border rounded p-3 d-none">
                    <div class="mb-2 small fw-bold">Upload CSV</div>
                    <input id="csvInput" type="file" accept=".csv" class="form-control form-control-sm mb-2">
                    <div class="small text-muted mb-2">First row should contain column headers (item codes). Values must be numeric for Likert items.</div>
                    <div class="d-flex flex-wrap gap-2 mb-2">
                        <button id="loadCsvBtn" class="btn btn-sm btn-primary" disabled>Load CSV</button>
                        <button id="downloadTemplateBtn" type="button" class="btn btn-sm btn-outline-secondary" title="Download a CSV template with item headers">Download Template</button>
                    </div>
                    <div class="small text-muted">Template uses current or prior step item codes (if available) and inserts two example rows.</div>
                </div>
                <div class="mt-2">
                    <button id="loadSimBtn" class="btn btn-sm btn-outline-primary">Refresh Simulated Data</button>
                </div>
            </div>
        </div>

        <div class="card mb-4" id="columnsCard">
            <div class="card-body">
                <h4 class="card-title mb-3">Columns & Reverse Scoring</h4>
                <div class="row g-3 mb-3">
                    <div class="col-auto">
                        <label class="form-label small mb-1" for="scaleMinInput">Scale Min</label>
                        <input type="number" id="scaleMinInput" class="form-control form-control-sm" min="0" max="10" value="1" style="width:90px;">
                    </div>
                    <div class="col-auto">
                        <label class="form-label small mb-1" for="scaleMaxInput">Scale Max</label>
                        <input type="number" id="scaleMaxInput" class="form-control form-control-sm" min="0" max="10" value="5" style="width:90px;">
                    </div>
                    <div class="col d-flex align-items-end gap-2 flex-wrap">
                        <button id="applyReverseBtn" class="btn btn-sm btn-primary" disabled>Apply Reverse to Selected</button>
                        <button id="selectAllReverseBtn" class="btn btn-sm btn-outline-secondary" disabled>Select All</button>
                        <button id="clearReverseSelectionBtn" class="btn btn-sm btn-outline-secondary" disabled>Clear Selection</button>
                        <button id="resetStep6Btn" class="btn btn-sm btn-outline-danger" disabled title="Reset scale, reversed selections, view mode, and reload underlying data (if simulated).">Reset All</button>
                    </div>
                </div>
                <div id="columnsList" class="small" style="max-height:200px; overflow:auto; border:1px solid var(--bs-border-color); border-radius:4px; padding:6px;">
                    <div class="text-muted">No data loaded yet.</div>
                </div>
                <div class="form-text mt-2">Check items that are reverse-keyed (semantic opposite). They will be transformed using: new = (Min + Max) - old.</div>
                    
                <div class="d-flex align-items-center gap-2 my-3">
                    <button type="button" class="btn btn-info btn-sm" id="btnSuggestReverse" title="Get AI-based model suggestions"><i class="bi bi-lightbulb"></i></button>
                </div>
                <div id="aiReverseSuggestionCard" class="card d-none my-3 text-bg-light" data-bs-theme="light">
                    <div class="card-body p-2">
                        <strong class="small">AI Suggestion</strong>
                        <div class="small" id="aiReverseSuggestionBody"><span class="text-muted">No suggestion yet.</span></div>
                    </div>
                </div>
                <hr class="my-3" />
                <h4 class="card-title mb-0">Data Preview</h4>
                <h4 class="visually-hidden">Hidden</h4>
                                <div class="d-flex flex-wrap gap-2 mb-2">
                                        <button id="showOriginalBtn" class="btn btn-sm btn-outline-secondary" disabled>Show Original</button>
                                        <button id="showReversedBtn" class="btn btn-sm btn-outline-secondary" disabled>Show Reversed</button>
                                        <span class="small align-self-center" id="viewModeLabel"></span>
                                </div>
                <div id="step6Table" class="mb-2"></div>
                <div class="small text-muted" id="dataStatus"></div>
                                <div class="small mt-2"><span class="badge bg-warning text-dark">R</span> marked columns are reverse-keyed relative to the original data.</div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="card mb-5" id="lavaanCardStep6">
            <div class="card-body">
                <h4 class="card-title mb-3">Model Specification (lavaan)</h4>
                <div class="small text-muted mb-2">Pulled from Step 4. You can edit below; changes are persisted only for Step 6 analyses (original auto-generation in Step 4 remains unchanged).</div>
                <div class="d-flex flex-wrap gap-2 mb-2">
                    <button id="btnDeleteEditedLavaan" class="btn btn-sm btn-outline-danger" type="button" disabled>Delete Edited</button>
                    <button id="btnSaveEditedLavaan" class="btn btn-sm btn-primary" disabled>Save Edits</button>
                    <div class="vr d-none d-sm-block" style="height:24px;"></div>
                    <button id="btnShowOriginalLavaan" class="btn btn-sm btn-outline-secondary" type="button">Original</button>
                    <button id="btnShowEditedLavaan" class="btn btn-sm btn-outline-secondary" type="button" disabled>Edited</button>
                    <span id="lavaanStep6Status" class="small text-muted"></span>
                </div>
                <textarea id="lavaanStep6Textarea" class="form-control font-monospace" rows="14" spellcheck="false" style="white-space:pre; overflow:auto; font-size:13px;"></textarea>
                <div class="form-text mt-2">Use "Delete Edited" to discard your saved edited version and revert to the original from Step 4.</div>
            </div>
        </div>
        <div class="card mb-5" id="efaAnalysisCard">
            <div class="card-body">
                <h4 class="card-title mb-3">Exploratory Factor Analysis (EFA)</h4>
                <div class="row g-2 align-items-end mb-2">
                    <div class="col-auto">
                        <label class="form-label small mb-1" for="efaNFactors"># Factors</label>
                        <input type="text" id="efaNFactors" class="form-control form-control-sm" value="auto" style="width:90px" title="Integer or 'auto'" />
                    </div>
                    <div class="col-auto">
                        <label class="form-label small mb-1" for="efaRotation">Rotation</label>
                        <select id="efaRotation" class="form-select form-select-sm" style="width:120px">
                            <option value="oblimin" selected>oblimin</option>
                            <option value="varimax">varimax</option>
                            <option value="promax">promax</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <label class="form-label small mb-1" for="checkOnlyIncludeRef">Only include reflective non globals</label>
                        <input type="checkbox" id="checkOnlyIncludeRef" class="form-check-input" checked/>
                    </div>
                    <div class="col-auto d-flex gap-2">
                        <button id="btnRunEFA" class="btn btn-sm btn-secondary" disabled>Run EFA</button>
                        <span id="efaStatus" class="small text-muted align-self-center"></span>
                    </div>
                </div>
                <div id="efaResults" class="mt-2 small font-monospace border rounded p-2" style="white-space:pre; overflow:auto; max-height:320px; min-height:60px;">
                    <span class="text-muted">No EFA run yet.</span>
                </div>
            </div>
        </div>
        <div class="card mb-5" id="cfaAnalysisCard">
            <div class="card-body">
                <h4 class="card-title mb-3">Evaluate goodness of fit of the measurement model</h4>
                <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                    <button id="btnRunCFA" class="btn btn-sm btn-success" disabled>Analyze</button>
                    <span id="cfaStatus" class="small text-muted"></span>
                </div>
                <div id="cfaResults" class="mt-3 border rounded p-3" style="white-space:normal; overflow:visible; min-height:120px; font-size:0.95rem;">
                    <span class="text-muted">No analysis run yet.</span>
                </div>
            </div>
        </div>

    </div>
</div>

<style>
    #columnsList .reversed-col{ background:#fff3cd; border-radius:3px; padding:2px 4px; color:rgb(54, 54, 54) }
    #columnsList label.reversed-col input{ margin-right:3px; }
</style>

<style>
    /* Enlarged CFA results presentation */
        #cfaResults.cfa-rich { font-family: system-ui, Arial, sans-serif; line-height:1.45; font-size:1.05rem; }
        #cfaResults.cfa-rich h6 { font-size:1.18rem; margin-top:1.35rem; }
        #cfaResults.cfa-rich table { font-size:0.95rem; }
        #cfaResults.cfa-rich td, #cfaResults.cfa-rich th { padding:.4rem .55rem; }
    #cfaResults.cfa-rich .badge { font-weight:500; }
    #cfaResults.cfa-rich .table-responsive { margin-bottom:.75rem; }
</style>

<style>
    .tabulator{
        border-radius: 6px;
        max-height: 500px;
        width: fit-content;
        max-width: 100%;
    }
</style>