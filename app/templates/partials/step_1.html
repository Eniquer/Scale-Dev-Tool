<div class="container-fluid">
    <h2 class="h3 mb-4 text-light">Step 1: Input Data</h2>
    <div class="card bg-secondary                     // Calculate dynamic width for row index column based on number of rows
                    const rowCount = data.length;
                    const maxRowDigits = rowCount.toString().length;
                    const dynamicWidth = Math.max(40, (maxRowDigits * 12) + 20); // 12px per digit + 20px padding

                    // Create Tabulator columns with row count as first column
                    const columns = [
                        {
                            title: "#",
                            field: "rowIndex",
                            sorter: "number",
                            editor: false,
                            width: dynamicWidth,
                            frozen: true,
                            headerSort: false,
                            formatter: function(cell, formatterParams, onRendered) {
                                return cell.getRow().getPosition();
                            }
                        },ry">
        <div class="card-body">
            <p class="card-text text-light">Please upload your CSV file to start the item generation process.</p>
            <form hx-post="/analyze" hx-encoding="multipart/form-data" hx-target="#content">
                <div class="mb-3">
                    <input id="csvInput" type="file" name="file" accept=".csv" class="form-control bg-dark border-secondary text-light" required>
                </div>
                <button type="submit" id="csvInputButton" class="btn btn-primary">Upload & Analyze</button>
            </form>
            
            <!-- Container for CSV table display -->
            <div id="csv-table-container" class="mt-4" style="display: none;">
                <h5 class="text-light mb-3">CSV Data Preview</h5>
                    <div id="csv-table" style="background-color: #343a40; border-radius: 0.375rem; overflow: auto;"></div>
            </div>
            
            <!-- Include Tabulator CSS and JS -->
            <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
            <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
            
            <!-- Custom dark theme CSS for Tabulator -->
            <style>
                .tabulator {
                    background-color: #343a40 !important;
                    color: #fff !important;
                    border: 1px solid #495057 !important;
                }
                .tabulator .tabulator-header {
                    background-color: #495057 !important;
                    border-bottom: 1px solid #6c757d !important;
                }
                .tabulator .tabulator-header .tabulator-col {
                    background-color: #495057 !important;
                    color: #fff !important;
                    border-right: 1px solid #6c757d !important;
                }
                .tabulator .tabulator-tableholder .tabulator-table .tabulator-row {
                    background-color: #343a40 !important;
                    color: #fff !important;
                    border-bottom: 1px solid #495057 !important;
                }
                .tabulator .tabulator-tableholder .tabulator-table .tabulator-row:nth-child(even) {
                    background-color: #3d444b !important;
                }
                .tabulator .tabulator-tableholder .tabulator-table .tabulator-row .tabulator-cell {
                    border-right: 1px solid #495057 !important;
                    color: #fff !important;
                }
                .tabulator .tabulator-tableholder .tabulator-table .tabulator-row:hover {
                    background-color: #495057 !important;
                }
                .tabulator .tabulator-header .tabulator-col input {
                    background-color: #212529 !important;
                    color: #fff !important;
                    border: 1px solid #495057 !important;
                }
            </style>
            <script>
                // Initialize IndexedDB for CSV storage
                if (!window.csvDB) {            
                    const dbRequest = indexedDB.open('csv-store', 1);
                    dbRequest.onupgradeneeded = (event) => {
                        event.target.result.createObjectStore('files');
                        console.log('IndexedDB object store created');
                    };
                    dbRequest.onsuccess = (event) => {
                        window.csvDB = event.target.result;
                        console.log('IndexedDB initialized successfully');
                         // Try to load existing CSV data if available
                        window.getStoredCSV().then(csvText => {
                            console.log('Found existing CSV data:', csvText.length, 'characters');
                            displayCSVTable(csvText);
                        }).catch(err => {
                            console.log('No existing CSV data found');
                        });
                    };
                    dbRequest.onerror = (event) => console.error('IndexedDB error:', event.target.error);
                }

                // Function to retrieve CSV content from IndexedDB
                window.getStoredCSV = function() {
                    return new Promise((resolve, reject) => {
                        if (!window.csvDB) {
                            reject('IndexedDB not initialized');
                            return;
                        }
                        
                        const tx = window.csvDB.transaction('files', 'readonly');
                        const request = tx.objectStore('files').get('uploadedCSV');
                        
                        request.onsuccess = () => {
                            if (request.result) {
                                console.log('CSV retrieved from IndexedDB');
                                resolve(request.result);
                            } else {
                                reject('No CSV found in storage');
                            }
                        };
                        
                        request.onerror = () => reject('Error retrieving CSV from IndexedDB');
                    });
                };

                // Function to display CSV data in a beautiful table
                function displayCSVTable(csvText) {
                    const lines = csvText.trim().split('\n');
                    const headers = lines[0].split(',').map(h => h.trim());
                    const data = lines.slice(1).map(line => {
                        const values = line.split(',');
                        return headers.reduce((obj, header, index) => {
                            obj[header] = values[index]?.trim() || '';
                            return obj;
                        }, {});
                    });

                    // Calculate dynamic width for row index column based on number of rows
                    const rowCount = data.length;
                    const digitCount = rowCount.toString().length;
                    // Base width of 30px + 10px per digit + padding
                    const indexColumnWidth = Math.max(40, 30 + (digitCount * 10));

                    // Create Tabulator columns with row count as first column
                    const columns = [
                        {
                            title: "#",
                            field: "rowIndex",
                            sorter: "number",
                            editor: false,
                            width: indexColumnWidth,
                            frozen: true,
                            headerSort: false,
                            formatter: function(cell, formatterParams, onRendered) {
                                return cell.getRow().getPosition();
                            }
                        },
                        ...headers.map(header => ({
                            title: header,
                            field: header,
                            sorter: "string",
                            editor: false
                        }))
                    ];

                    // Initialize Tabulator table
                    const table = new Tabulator("#csv-table", {
                        data: data,
                        columns: columns,
                        layout: "fitDataFill",
                        height: "500px",
                        maxHeight: "70vh",
                        virtualDomHoz: true,
                        pagination: false,
                        headerFilter: true,
                        headerFilterPlaceholder: "Filter...",
                        responsiveLayout: false,
                        columnDefaults: {
                            headerSort: true,
                            resizable: true,
                            minWidth: 100
                        },
                        scrollToColumnPosition: "center",
                        scrollToRowPosition: "center"
                    });

                    // Show the table container
                    document.getElementById('csv-table-container').style.display = 'block';
                    
                    console.log(`Displayed CSV table: ${data.length} rows, ${headers.length} columns`);
                }

                // Helper function to check if CSV data exists and display status
                window.checkStoredCSV = function() {
                    window.getStoredCSV().then(csvText => {
                        const lines = csvText.split('\n');
                        const rows = lines.length - 1; // minus header
                        console.log(`CSV loaded: ${rows} rows, ${lines[0].split(',').length} columns`);
                        
                        // You could update UI here to show "Data loaded" status
                        const messageDiv = document.querySelector('.alert');
                        if (messageDiv) {
                            messageDiv.innerHTML = `CSV data ready: ${rows} rows`;
                            messageDiv.className = 'alert alert-success mt-3';
                        }
                    }).catch(err => {
                        console.log('No CSV data available yet');
                    });
                };

                // Capture CSV text on button click
                document.getElementById('csvInputButton').addEventListener('click', async (e) => {
                    const file = document.getElementById('csvInput').files[0];
                    if (file) {
                        window.pendingCSV = await file.text();
                        console.log('CSV text captured for later storage');
                    }
                });

                // Listen for successful analyze requests
                document.addEventListener('htmx:afterRequest', function(evt) {
                    const requestPath = evt.detail.pathInfo?.finalRequestPath || evt.detail.pathInfo?.requestPath || '';
                    if (requestPath.includes('/analyze') && 
                        evt.detail.xhr.status >= 200 && evt.detail.xhr.status < 300 &&
                        window.pendingCSV && window.csvDB) {
                        
                        console.log('Storing CSV in IndexedDB after successful analyze');
                        const tx = window.csvDB.transaction('files', 'readwrite');
                        tx.objectStore('files').put(window.pendingCSV, 'uploadedCSV');
                        tx.oncomplete = () => {
                            console.log('CSV saved to IndexedDB');
                            window.pendingCSV = null; // Clear pending data
                            
                            // Display the newly uploaded CSV
                            window.getStoredCSV().then(csvText => {
                                displayCSVTable(csvText);
                            });
                        };
                    }
                });
            </script>
            {% if message %}
                <div class="alert alert-info mt-3">{{ message }}</div>
            {% endif %}


        </div>
    </div>
</div>