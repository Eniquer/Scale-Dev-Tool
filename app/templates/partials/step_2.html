<div id="area1">
    <h2 class="h3 mb-4 text-light">Step 2: Input Data</h2>
    <div class="card bg-secondary border-secondary">
        <div class="card-body">
            <p class="card-text text-light">Please upload your CSV file to start the item generation process.</p>
            <form hx-post="/analyze" hx-encoding="multipart/form-data" hx-target="#content">
                <div class="mb-3">
                    <input id="csvInput" type="file" name="file" accept=".csv"
                        class="form-control bg-dark border-secondary text-light" required>
                </div>
                <button type="submit" id="csvInputButton" class="btn btn-primary mb-3">Upload & Analyze</button>
            </form>
            <div id="tableContent">

                <!-- Column Selection for Reversal -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h5 class="text-light mb-3">Select Columns to Reverse</h5>
                        <div class="card bg-dark border-secondary">
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label for="likertMin" class="form-label text-light">Minimum Value</label>
                                        <input type="number" class="form-control bg-dark border-secondary text-light"
                                            id="likertMin" value="1" min="0" max="10">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="likertMax" class="form-label text-light">Maximum Value</label>
                                        <input type="number" class="form-control bg-dark border-secondary text-light"
                                            id="likertMax" value="5" min="1" max="10">
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-outline-light btn-sm me-2"
                                            onclick="selectAllColumns()">Select All</button>
                                        <button type="button" class="btn btn-outline-light btn-sm me-2"
                                            onclick="deselectAllColumns()">Deselect All</button>
                                    </div>
                                </div>
                                <div id="columnCheckboxes" class="row">
                                    <!-- Column checkboxes will be populated here -->
                                </div>
                                <div class="col-12 text-end">
                                    <button type="button" class="btn btn-primary"
                                        onclick="reverseSelectedColumns()">Reverse Selected Columns</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card bg-dark border-secondary mb-3">
                    <div class="card-body">
                        <p class="card-text text-light">Columns that are or were reverted: <span
                                id="reversedDataColumns"></span></p>
                        <div class="row">
                            <div class="col-12 text-end">
                                <button id="storeRevertChanges" type="button" class="btn btn-primary"
                                    onclick="storeChanges()" disabled>Store Changes</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>




            {% if message %}
            <div class="alert alert-info mt-3">{{ message }}</div>
            {% endif %}
        </div>
    </div>
</div>
                        
<div id="area2">
    <div id="json-table"></div>
</div>

{% if csv_data %}


<script>


    // Use var instead of let to allow redeclaration, or overwrite existing variable
    window.csvData = {{ csv_data | tojson }};

    // Store as JSON string in IndexedDB
    window.csvStorage.storeCSV(JSON.stringify(window.csvData)).then((storedCSV) => {
        displayTable(window.csvData, "#json-table"); // Call the function to display the table
    }).catch((error) => {
        console.error("Error storing CSV data:", error);
        document.getElementById("tableContent").innerHTML = `<div class="alert alert-danger">Error storing CSV data: ${error.message}</div>`;
    });


</script>
{% endif %}

<script>
    //Todo load newest reverted data not the original data 

    columnsReverted = [];
    newData = null;

    // Populate column checkboxes
    function populateColumnCheckboxes() {
        const checkboxContainer = document.getElementById('columnCheckboxes');
        if (!checkboxContainer || !window.csvData || window.csvData.length === 0) return;
        console.log(window.csvData);

        const columns = Object.keys(window.csvData[0] || {});
        checkboxContainer.innerHTML = '';

        columns.forEach((column, index) => {
            const colDiv = document.createElement('div');
            colDiv.className = 'col-md-3 col-sm-6 mb-2';
            colDiv.innerHTML = `
                            <div class="form-check" style="overflow-x: auto;">
                                <input class="form-check-input bg-dark border-secondary" type="checkbox" 
                                       value="${column}" id="col_${index}" data-column="${column}">
                                <label class="form-check-label text-light" for="col_${index}">
                                    ${column}
                                </label>
                            </div>
                        `;
            checkboxContainer.appendChild(colDiv);
        });
    }

    // Column selection functions
    function selectAllColumns() {
        const checkboxes = document.querySelectorAll('#columnCheckboxes input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = true);
    };

    window.deselectAllColumns = function () {
        const checkboxes = document.querySelectorAll('#columnCheckboxes input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
    };

    window.updateLikertScale = function () {
        const min = parseInt(document.getElementById('likertMin').value);
        const max = parseInt(document.getElementById('likertMax').value);

        if (min >= max) {
            alert('Minimum value must be less than maximum value');
            return false;
        }

        console.log(`Likert scale updated: ${min} to ${max}`);
        // Store the scale values globally for reversal calculation
        window.likertScale = { min, max };
        return true;
    };

    window.reverseSelectedColumns = function () {
        // Ensure Likert scale is set
        if (!window.updateLikertScale()) return;

        const selectedColumns = [];
        const checkboxes = document.querySelectorAll('#columnCheckboxes input[type="checkbox"]:checked');

        checkboxes.forEach(cb => {
            selectedColumns.push(cb.getAttribute('data-column'));
        });

        if (selectedColumns.length === 0) {
            alert('Please select at least one column to reverse');
            return;
        }

        // Check if the columns are ones once reverted
        const conditionsReverted = selectedColumns.filter(col => columnsReverted.includes(col));
        if (conditionsReverted.length > 0) {
            if (!confirm(`The following columns have already been reverted: ${conditionsReverted.join(', ')}. Do you want to ignore this and proceed? They will be reverted again.`)) {
                console.log("User chose not to proceed with reversal of already reverted columns.");
                return;
            }
        }

        const min = parseInt(document.getElementById('likertMin').value);
        const max = parseInt(document.getElementById('likertMax').value);

        if (min >= max) {
            alert('Please set valid Likert scale values (min < max)');
            return;
        }

        // Perform reversal
        changingData = newData || window.csvData; // Use reverted data if available, otherwise original data
        const reversedData = changingData.map(row => {
            const newRow = { ...row };
            selectedColumns.forEach(col => {
                if (newRow[col] !== null && newRow[col] !== undefined && newRow[col] !== '' && !isNaN(newRow[col])) {
                    newRow[col] = min + max - parseFloat(newRow[col]);
                }
            });
            return newRow;
        });


        selectedColumns.forEach(col => {
            if (!columnsReverted.includes(col)) {
                columnsReverted.push(col);
            }
        });
        document.getElementById('reversedDataColumns').innerText = columnsReverted.join(', ');

        if (columnsReverted.length > 0) {
            document.getElementById('storeRevertChanges').disabled = false; // Enable the store changes button
        } else {
            document.getElementById('storeRevertChanges').disabled = true; // Disable if no columns were reverted
        }

        console.log("Reversed data:", reversedData[0]);

        newData = reversedData; // Store the new data 

        displayTable(reversedData, "#json-table");


    };

    function storeChanges() {
        window.csvDataReverted = newData || window.csvData; // Use newData if available, otherwise original data
        displayInfo("success", `New data stored with ${columnsReverted.length} reversed column(s): ${columnsReverted.join(', ')}`);
        // Store updated data
        window.csvStorage.storeCSV(JSON.stringify(window.csvDataReverted), 'csvDataReverted', false);

    }

    // Initialize
    populateColumnCheckboxes();
    window.likertScale = { min: 1, max: 5 };

</script>